import React from 'react';
import { useGame } from '../contexts/GameContext';
import { useNotification } from '../contexts/NotificationContext';
import ApiService from '../services/api';

const VulnerabilityTester = () => {
    const { gamePlayer, submitFlag } = useGame();
    const { showNotification } = useNotification();

    const testAllVulnerabilities = async () => {
        if (!gamePlayer) {
            showNotification('Debes registrarte como jugador primero', 'error');
            return;
        }

        console.log('ðŸ§ª Probando todas las vulnerabilidades...');

        try {
            // 1. SQL Injection en Login
            const sqlInjectionLogin = await ApiService.testSQLInjectionLogin({
                username: "' OR '1'='1' --",
                password: "test"
            });
            
            if (sqlInjectionLogin.flag) {
                await submitFlag(sqlInjectionLogin.flag);
                showNotification(`âœ… SQL Injection Login: ${sqlInjectionLogin.flag}`, 'success');
            }

            // 2. SQL Injection en BÃºsqueda
            const sqlInjectionSearch = await ApiService.testSQLInjectionSearch("test' OR '1'='1");
            
            if (sqlInjectionSearch.flag) {
                await submitFlag(sqlInjectionSearch.flag);
                showNotification(`âœ… SQL Injection BÃºsqueda: ${sqlInjectionSearch.flag}`, 'success');
            }

            // 3. Information Disclosure
            const infoDisclosure = await ApiService.testInformationDisclosure();
            
            if (infoDisclosure.flag) {
                await submitFlag(infoDisclosure.flag);
                showNotification(`âœ… Information Disclosure: ${infoDisclosure.flag}`, 'success');
            }

            // 4. Weak Authentication
            const weakAuth = await ApiService.testWeakAuthentication({
                username: "abuela",
                password: "abuela123"
            });
            
            if (weakAuth.flag) {
                await submitFlag(weakAuth.flag);
                showNotification(`âœ… Weak Authentication: ${weakAuth.flag}`, 'success');
            }

            showNotification('Â¡Todas las vulnerabilidades probadas! Revisa tu puntuaciÃ³n.', 'success');
            
        } catch (error) {
            showNotification('Error al probar vulnerabilidades: ' + error.message, 'error');
        }
    };

    return (
        <div className="bg-white rounded-3xl shadow-2xl p-6 mb-8">
            <h3 className="text-2xl font-bold text-gray-800 mb-4">ðŸ§ª Probador de Vulnerabilidades</h3>
            <p className="text-gray-600 mb-4">
                Ejecuta todas las pruebas automÃ¡ticamente para capturar flags.
            </p>
            
            <button
                onClick={testAllVulnerabilities}
                className="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 px-4 rounded-2xl font-semibold hover:from-purple-600 hover:to-indigo-700 transition-all duration-200"
            >
                ðŸš€ Ejecutar Todas las Pruebas
            </button>

            <div className="mt-4 p-4 bg-blue-50 rounded-2xl border border-blue-200">
                <h4 className="font-semibold text-blue-800 mb-2">Vulnerabilidades a probar:</h4>
                <ul className="text-sm text-blue-700 space-y-1">
                    <li>â€¢ SQL Injection en Login</li>
                    <li>â€¢ SQL Injection en BÃºsqueda</li>
                    <li>â€¢ Information Disclosure</li>
                    <li>â€¢ Weak Authentication</li>
                </ul>
            </div>
        </div>
    );
};

export default VulnerabilityTester;